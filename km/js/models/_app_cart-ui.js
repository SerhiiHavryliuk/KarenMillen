"use strict";function _classCallCheck(t,a){if(!(t instanceof a))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,a){for(var r=0;r<a.length;r++){var e=a[r];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(a,r,e){return r&&t(a.prototype,r),e&&t(a,e),a}}(),FrondevoCartUI=function(){function t(){_classCallCheck(this,t),this.cartSizeCheckAttr="data-cart-size-check",this.cartSizeCheck=$("["+this.cartSizeCheckAttr+"]"),this.cartSizeClassActive="button-size_active",this.cartSizeWrongMsg=$("[data-cart-size-wrong]"),this.cartSizeSucssesMsg=$("[data-cart-size-sucsses]"),this.cartFavoriteucssesMsg=$("[data-cart-favorite-sucsses]"),this.cartItemDel=$("[data-cart-delete-item]"),this.cartRowSelector="[data-cart-object]",this.cartIdAttr="data-cart-id",this.cartSizeAttr="data-cart-size",this.cartNumAttr="data-cart-num",this.cartPriceAttr="data-cart-price",this.cartCostAttr="data-cart-cost",this.cartSincUrlAttr="data-cart-sinc-url",this.cartUrlAttr="data-cart-url",this.cartAddBtn=$("[data-cart-add]"),this.cartAddToFavoriteBtn=$("[data-cart-add-to-favorite]"),this.cartLogoutAddToFavoriteBtn=$("[data-cart-logout-add-to-favorite]"),this.cartNumInput=$("[data-cart-val-num]"),this.cartSizeInput=$("[data-cart-val-size]"),this.cartPromoSubmitUrlAttr="data-cart-promo-url",this.cartPromoSubmit=$("["+this.cartPromoSubmitUrlAttr+"]"),this.cartPromoInput=$("[data-cart-promo-code]"),this.cartDiscountSubmitUrlAttr="data-cart-discount-url",this.cartDiscountSubmit=$("["+this.cartDiscountSubmitUrlAttr+"]"),this.cartDiscountInput=$("[data-cart-discount-code]"),this.cartDiscountMsg=$("[data-cart-discount-msg]"),this.cartTotal=$("[data-cart-total]"),this.cartHeaderNum=$("[data-cart-header-num]"),this.cartEmptyMsgAttr="data-cart-empty-msg",this.cartEmptyMsg=$("["+this.cartEmptyMsgAttr+"]"),this.cartPageEl=$(".cart-page"),this.cartEmptyPageClass="cart-page_empty",this.cartEmptyHide=$("[data-cart-hide-if-empty]"),this.cartHeaderIcon=$("[data-cart-popup]"),this.cartHeaderEmptyClass="header_basket-empty",this.cartPopupSelector="#cartPopup",this.cartPopupCont=$("[data-cart-popup-cont]"),this.cartPopupText=$("[data-cart-popup-info]"),this.cartPopupLoadAttr="data-cart-popup-load-url",this.errorMsgCart="Не удалось загрузить данные корзины!",this.errorMsgEmptyInput="Заполните поле!",this.Timer,this.cart=[],this.cartEl=$(this.cartPopupSelector),this.cartOpenClass="open",this.flagIsUnderCart=!1,this._initModules(),this._eventHandlersInit()}return _createClass(t,[{key:"_initModules",value:function(){if(varsAPP.supportStorage){var t=localStorage.getItem("versionCart"),a=1;t!=a&&localStorage.removeItem("cart"),localStorage.setItem("versionCart",a),this.cart=JSON.parse(localStorage.getItem("cart"))}else this.cart=[];if(null==this.cart&&(this.cart=[]),varsAPP.supportStorage){var r=sessionStorage.getItem("sinc");this.cart==[]||r||(sessionStorage.setItem("sinc",1),this._cartSinc())}else this._cartSinc();$(".select-selectric").selectric()}},{key:"_firedIfUnderCart",value:function(){this.flagIsUnderCart=!0}},{key:"_checkIsStillUnderCart",value:function(){if(1==this.flagIsUnderCart){var t=$.Event("cursorUnderCart");return this.cartEl.trigger(t),this}}},{key:"_firedIfLeaveCart",value:function(){this.flagIsUnderCart=!1;var t=$.Event("cursorLeaveCart");return this.cartEl.trigger(t),this}},{key:"_sizeCheck",value:function(t){$("["+this.cartSizeCheckAttr+"]").removeClass(this.cartSizeClassActive),$(t).addClass(this.cartSizeClassActive),this.cartAddBtn.attr(this.cartSizeAttr,$(t).attr(this.cartSizeCheckAttr)),this.cartSizeWrongMsg.css("display","none"),this.cartSizeSucssesMsg.css("display","none")}},{key:"_addToCart",value:function(t){var a=t;$(t)[0].hasAttribute("data-cart-add")||(a=$(t).parents("[data-cart-add]"),console.log(a));var r=$(a).attr(this.cartIdAttr),e=$(a).attr(this.cartSizeAttr),s=1;if(e){this.cartSizeSucssesMsg.css("display","block");var c="action='add'&goodId="+r+"&size="+e+"&num="+s;this._cartChange(c,!0,!0),this._addCartSrorage(r,e,s)}else this.cartSizeWrongMsg.css("display","block")}},{key:"_addToFavoriteLogout",value:function(t){var a=this.cartAddBtn,r=($(a).attr(this.cartIdAttr),$(a).attr(this.cartSizeAttr));r||(this.cartSizeWrongMsg.css("display","block"),t.preventDefault())}},{key:"_addToFavorite",value:function(){var t=this.cartAddBtn,a=$(t).attr(this.cartIdAttr),r=$(t).attr(this.cartSizeAttr);if(r){this.cartFavoriteucssesMsg.css("display","block");var e="goodId="+a+"&size="+r;this.cartAddToFavoriteBtn.hasClass("active")?(e+="&action=remove",this.cartAddToFavoriteBtn.removeClass("active")):(e+="&action=add",this.cartAddToFavoriteBtn.addClass("active"),$("[data-cart-favorite]").addClass("active")),$.ajax({url:this.cartAddToFavoriteBtn.attr("data-cart-add-to-favorite"),method:"get",data:e,dataType:"json",success:function(t){0==t.kol&&$("[data-cart-favorite]").removeClass("active")},error:function(t){console.error(cartUI.errorMsgCart,t)}})}else this.cartSizeWrongMsg.css("display","block")}},{key:"_submitPromoCode",value:function(){var t=this.cartPromoInput.val();""!=t?$.ajax({url:this.cartPromoSubmit.attr(this.cartPromoSubmitUrlAttr),method:"get",data:"promocode="+this.cartPromoInput.val(),dataType:"json",success:function(t){"OK"==t.status.toUpperCase()?(cartUI.cartDiscountMsg.html(t.pageMessage),cartUI.cartTotal.text(t.total),this.cartPromoInput.next(".error-text").remove()):vaildateAPP.error(cartUI.cartPromoInput.parent(),t.msg)},error:function(t){console.error(cartUI.errorMsgCart,t)}}):vaildateAPP.error(this.cartPromoInput.parent(),this.errorMsgEmptyInput)}},{key:"_submitDiscountCode",value:function(){var t=this.cartDiscountInput.val();""!=t?$.ajax({url:this.cartDiscountSubmit.attr(this.cartDiscountSubmitUrlAttr),method:"get",data:"discountcode="+this.cartDiscountInput.val(),dataType:"json",success:function(t){"OK"==t.status.toUpperCase()?(cartUI.cartDiscountMsg.html(t.pageMessage),cartUI.cartTotal.text(t.total),this.cartDiscountInput.next(".error-text").remove()):vaildateAPP.error(cartUI.cartDiscountInput.parent(),t.msg)},error:function(t){console.error(cartUI.errorMsgCart,t)}}):vaildateAPP.error(this.cartDiscountInput.parent(),this.errorMsgEmptyInput)}},{key:"_cartSinc",value:function(){$.ajax({url:$("["+this.cartSincUrlAttr+"]").attr(this.cartSincUrlAttr),method:"get",data:"cart="+JSON.stringify(this.cart),dataType:"json",success:function(t){cartUI.cart=t.cart,varsAPP.supportStorage&&localStorage.setItem("cart",JSON.stringify(cartUI.cart))},error:function(t){console.error(cartUI.errorMsgCart,t)}})}},{key:"_delInCart",value:function(t){var a=$(t).parents(this.cartRowSelector),r=a.attr(this.cartIdAttr),e=a.attr(this.cartSizeAttr),s="action='delete'&goodId="+r+"&size="+e;this._cartChange(s),this._delCartStorage(r,e),a.remove()}},{key:"_numChangeInCart",value:function(t){var a=$(t).val(),r=$(t).parents(this.cartRowSelector),e=r.attr(this.cartIdAttr),s=r.attr(this.cartSizeAttr);r.attr(this.cartNumAttr,a);var c="action='edit'&goodId="+e+"&size="+s+"&num="+a;this._cartChange(c),this._editCartSrorage(e,s,a),r.find("["+this.cartCostAttr+"]").text(parseFloat(r.find("["+this.cartPriceAttr+"]").text())*a)}},{key:"_sizeChangeInCart",value:function(t){var a=$(t).val(),r=$(t).parents(this.cartRowSelector),e=r.attr(this.cartIdAttr),s=r.attr(this.cartNumAttr),c=r.attr(this.cartSizeAttr);r.attr(this.cartSizeAttr,a);var i="action='delete'&goodId="+e+"&size="+c;this._cartChange(i,!1),i="action='add'&goodId="+e+"&size="+a+"&num="+s,this._cartChange(i),this._editCartSrorage(e,a,s)}},{key:"_cartChange",value:function(t){var a=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];$.ajax({url:$("["+this.cartUrlAttr+"]").attr(this.cartUrlAttr),method:"get",data:t,dataType:"json",success:function(t){var e=this;a&&(cartUI.cartHeaderNum.text(t.kol),cartUI.cartDiscountMsg.html(t.pageMessage),cartUI.cartTotal.text(t.total)),r&&(cartUI.cartPopupOpen(),setTimeout(function(){return e._cartPopupClose()},2500))},error:function(t){console.error(cartUI.errorMsgCart,t)}})}},{key:"_addCartSrorage",value:function(t,a,r){var e=this._findInCartStorage(t,a);e==-1?(this.cart.push({id:t,size:a,count:1}),varsAPP.supportStorage&&localStorage.setItem("cart",JSON.stringify(this.cart))):(this.cart[e].count++,varsAPP.supportStorage&&localStorage.setItem("cart",JSON.stringify(this.cart))),this.cartHeaderIcon.removeClass(this.cartHeaderEmptyClass)}},{key:"_editCartSrorage",value:function(t,a,r){var e=this._findInCartStorage(t,a);e!=-1&&(this.cart[e].count=parseInt(r),varsAPP.supportStorage&&localStorage.setItem("cart",JSON.stringify(this.cart)))}},{key:"_delCartStorage",value:function(t,a){var r=this._findInCartStorage(t,a);r!=-1&&(this.cart.splice(r,1),varsAPP.supportStorage&&localStorage.setItem("cart",JSON.stringify(this.cart))),0==this.cart.length&&(this.cartEmptyMsg.text(this.cartEmptyMsg.attr(this.cartEmptyMsgAttr)),this.cartEmptyHide.css("display","none"),this.cartHeaderIcon.addClass(this.cartHeaderEmptyClass),this.cartPageEl&&this.cartPageEl.addClass(this.cartEmptyPageClass))}},{key:"_findInCartStorage",value:function(t,a){for(var r=-1,e=0;e<this.cart.length;e++)if(this.cart[e].id==t&&this.cart[e].size==a){r=e;break}return r}},{key:"cartPopupOpen",value:function(){$.ajax({url:$("["+this.cartPopupLoadAttr+"]").attr(this.cartPopupLoadAttr),method:"get",dataType:"json",success:function(t){if(cartUI.cartPopupCont.html(t.htmlCode),cartUI.cartPopup=new FrondevoPopup({popupSelector:cartUI.cartPopupSelector,overlayStatus:!1}),cartUI.cartPopupText.html(t.text),cartUI.cartPopup.showPopup(),"desktop"==varsAPP.viewport.device&&$(this.cartPopupSelector).height()+120>varsAPP.viewport.height){var a=$("#cartPopup").height()+120-varsAPP.viewport.height,r=$(".F-popup_cart-list").height();$(".F-popup_cart-list").css("height",r-a),$(".F-popup_cart-list").addClass("F-popup_cart-list_long")}},error:function(t){console.error(cartUI.errorMsgCart,t)}})}},{key:"_cartPopupClose",value:function(){cartUI.cartPopup&&0==this.flagIsUnderCart&&cartUI.cartPopup.closePopup()}},{key:"_eventHandlersInit",value:function(){var t=this;this.cartEl.on("mouseenter",function(){return t._firedIfUnderCart()}),this.cartEl.on("mouseleave",function(){t._firedIfLeaveCart()}),this.cartEl.on("cursorLeaveCart",function(a){setTimeout(function(){return t._cartPopupClose()},300)}),this.cartHeaderIcon.on("mouseover",function(a){t._firedIfUnderCart(),t.cartHeaderIcon.hasClass(t.cartHeaderEmptyClass)||t.cartEl.hasClass(t.cartOpenClass)||t.cartPopupOpen()}),this.cartHeaderIcon.on("mouseleave",function(a){setTimeout(function(){return t._cartPopupClose()},300)}),this.cartSizeCheck.on("click",function(a){t._sizeCheck(a.target)}),this.cartAddToFavoriteBtn.on("click",function(a){t._addToFavorite(a.target)}),this.cartLogoutAddToFavoriteBtn.on("click",function(a){t._addToFavoriteLogout(a)}),this.cartAddBtn.on("click",function(a){t._addToCart(a.target)}),this.cartItemDel.on("click",function(a){t._delInCart(a.target)}),this.cartNumInput.on("change",function(a){t._numChangeInCart(a.target)}),this.cartSizeInput.on("change",function(a){t._sizeChangeInCart(a.target)}),this.cartPromoSubmit.on("click",function(a){t._submitPromoCode()}),this.cartDiscountSubmit.on("click",function(a){t._submitDiscountCode()})}}]),t}(),cartUI=new FrondevoCartUI;