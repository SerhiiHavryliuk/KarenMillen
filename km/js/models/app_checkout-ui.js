"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var d=e[a];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(t,d.key,d)}}return function(e,a,d){return a&&t(e.prototype,a),d&&t(e,d),e}}(),FrondevoCheckoutUI=function(){function t(){_classCallCheck(this,t),this.checkoutTabs=$(".checkout-box__title"),this.checkoutTabsBody="checkout-box-body",this.checkoutTabsMain=".checkout-box",this.checkoutTabsActiveClass="active",this.checkoutShopSelect=$("[data-checkout-shopsel]"),this.checkoutNoAddrRadio=$("[data-checkout-no-addr]"),this.checkoutAddrRadio=$('.checkout-box-body input[type="radio"]'),this.checkoutEditAddr=$("[data-checkout-addr-popup]"),this.checkoutAddrForm=$("#checkoutAddrForm"),this.errorMsgAddr="Не удалось отправить данные адреса!",this.autocomplete=$("[data-autocomplete-city]"),this.autocompleteInput=$("[data-autocomplete-input]"),this.autocompleteId=$("[data-autocomplete-id]"),this.autocompleteList=$("[data-autocomplete-list]"),this.depSelect=$("[data-checkout-dep]"),this.checkoutNext=$("[data-checkout-submit]"),this.paymentForm=$("[data-payment-form]"),this.statusAddress="",this.checkoutAddNewAddr=$(".checkout-address__link"),this.counter_new_addr_id=$(".checkout-address").length+1,this.numberOfAddedNewAddresses=0,this.idFormAddNewAddress=$("#checkoutAddNewAddrForm"),this._initModules(),this._eventHandlersInit()}return _createClass(t,[{key:"_initModules",value:function(){this.addrPopup=new FrondevoPopup({popupSelector:"#checkoutAddrPopup",overlayStatus:!0}),this.addNewaddrPopup=new FrondevoPopup({popupSelector:"#checkoutAddNewAddrPopup",overlayStatus:!0}),this._checkNumberOfAddresses()}},{key:"_checkNumberOfAddresses",value:function(){var t=$(".checkout-address").length;0==t?($(".checkout-box-msg").addClass(".checkout__visible"),$(".checkout-cost").addClass("checkout__hidden")):($(".checkout-cost").removeClass("checkout__hidden").addClass("checkout__visible"),$(".checkout-box-msg").removeClass(".checkout__visible").addClass("checkout__hidden")),this.numberOfAddedNewAddresses>0&&($(".checkout-cost").removeClass("checkout__hidden").addClass("checkout__visible"),$(".checkout-box-msg").removeClass(".checkout__visible").addClass("checkout__hidden"))}},{key:"_openEditAddrPopup",value:function(t){var e=$(t).parents("[data-checkout-addr-id]");$("#checkout-addr-id").val($.trim($(e).attr("data-checkout-addr-id"))),$("#checkout-addr-name").val($.trim($(e).find("[data-checkout-addr-name]").text())),$("#checkout-addr-surname").val($.trim($(e).find("[data-checkout-addr-surname]").text())),$("#checkout-addr-phone").val($.trim($(e).find("[data-checkout-addr-phone]").text())),$("#checkout-addr-city").val($.trim($(e).find("[data-checkout-addr-city]").text())),$("#checkout-addr-street").val($.trim($(e).find("[data-checkout-addr-street]").text())),$("#checkout-addr-build").val($.trim($(e).find("[data-checkout-addr-build]").text())),$("#checkout-addr-flat").val($.trim($(e).find("[data-checkout-addr-flat]").text())),$("#checkout-addr-index").val($.trim($(e).find("[data-checkout-addr-index]").text())),this.addrPopup.showPopup(),$("#status-addr").val("EditAddr")}},{key:"_openPopupForAddNewAddr",value:function(t){$("form input:text").val(""),$("#checkout-add-addr-name").val(this.idFormAddNewAddress.attr("data-account-name")),$("#checkout-add-addr-surname").val(this.idFormAddNewAddress.attr("data-account-surname")),$("#checkout-add-addr-phone").val(this.idFormAddNewAddress.attr("data-account-phone")),$("#status-add-addr").val("NewAddr"),this.numberOfAddedNewAddresses++,this.addNewaddrPopup.showPopup()}},{key:"_checkoutAddrFormSubmit",value:function(t){var e=$("#checkout-addr-id").val(),a=$("[data-checkout-addr-id="+e+"]");$(a).find("[data-checkout-addr-name]").text($("#checkout-addr-name").val()),$(a).find("[data-checkout-addr-surname]").text($("#checkout-addr-surname").val()),$(a).find("[data-checkout-addr-phone]").text($("#checkout-addr-phone").val()),$(a).find("[data-checkout-addr-city]").text($("#checkout-addr-city").val()),$(a).find("[data-checkout-addr-street]").text($("#checkout-addr-street").val()),$(a).find("[data-checkout-addr-build]").text($("#checkout-addr-build").val()),$(a).find("[data-checkout-addr-flat]").text($("#checkout-addr-flat").val()),$(a).find("[data-checkout-addr-index]").text($("#checkout-addr-index").val()),$.ajax({url:this.checkoutAddrForm.attr("action"),method:this.checkoutAddrForm.attr("method"),data:this.checkoutAddrForm.serialize(),dataType:"json",success:function(t){checkoutUI.addrPopup.closePopup()},error:function(t){console.error(checkoutUI.errorMsgAddr,t)}})}},{key:"_checkoutAddNewAddrFormSubmit",value:function(){$.ajax({url:this.idFormAddNewAddress.attr("action"),method:this.idFormAddNewAddress.attr("method"),data:this.idFormAddNewAddress.serialize(),dataType:"json",success:function(t){var e=t.idAddress;$("#checkout-add-addr-id").val(e);var a=$("#checkout-add-addr-name").val(),d=$("#checkout-add-addr-surname").val(),c=$("#checkout-add-addr-phone").val(),o=$("#checkout-add-addr-street").val(),s=$("#checkout-add-addr-build").val(),i=$("#checkout-add-addr-flat").val(),u=$("#checkout-add-addr-city").val(),r=$("#checkout-add-addr-index").val();$(".checkout-box-append").prepend('<div data-checkout-addr-id="'+e+'" class="checkout-address">      <label for="'+e+'" class="checkout-address__text"><span class="checkout-address__text-line"><span data-checkout-addr-name="data-checkout-addr-name">'+a+'</span><span data-checkout-addr-surname="data-checkout-addr-surname">'+d+'</span></span><span data-checkout-addr-phone="data-checkout-addr-phone" class="checkout-address__text-line">'+c+'</span><span class="checkout-address__text-line"><span data-checkout-addr-street="data-checkout-addr-street">'+o+'</span>,</span><span class="checkout-address__text-line"><span data-checkout-addr-build="data-checkout-addr-build"> д.'+s+'</span>,<span data-checkout-addr-flat="data-checkout-addr-flat"> кв.'+i+'</span>,</span><span class="checkout-address__text-line"><span data-checkout-addr-city="data-checkout-addr-city"> '+u+'</span>,</span><span data-checkout-addr-index="data-checkout-addr-index" class="checkout-address__text-line">'+r+'</span></label> <div class="checkout-address__check"> <div class="custom-checkbox">      <input id="'+e+'" value="'+e+'" name="checkout-addr" type="radio" />     <label for="'+e+'"></label></div></div><div class="checkout-address__edit"><label for="'+e+'" data-checkout-addr-popup="data-checkout-addr-popup">РЕД.</label></div></div>  '),checkoutUI.counter_new_addr_id++,"ok"==t.status&&checkoutUI.addNewaddrPopup.closePopup()},error:function(t){console.error(checkoutUI.errorMsgAddr,t)}})}},{key:"_toggleTab",value:function(t){var e=$(t).parents(this.checkoutTabsMain);e.hasClass(this.checkoutTabsActiveClass)?$(this.checkoutTabsMain).removeClass(this.checkoutTabsActiveClass):($(this.checkoutTabsMain).removeClass(this.checkoutTabsActiveClass),$(t).parents(this.checkoutTabsMain).addClass(this.checkoutTabsActiveClass))}},{key:"_deblockNextStep",value:function(){this.checkoutNext.removeAttr("disabled"),this.checkoutNoAddrRadio.prop("checked")&&"0"==this.checkoutShopSelect.val()&&"0"==this.depSelect.val()&&this.checkoutNext.attr("disabled","disabled")}},{key:"_changeShop",value:function(){this.checkoutNoAddrRadio.prop("checked",!0),$("#checkout-dep [value='0']").prop("selected",!0),$("#checkout-dep").sinhronize(),this._deblockNextStep()}},{key:"_changeAddrRadio",value:function(){$("#checkout-self [value='0']").prop("selected",!0),$("#checkout-self").sinhronize(),$("#checkout-dep [value='0']").prop("selected",!0),$("#checkout-dep").sinhronize(),this._deblockNextStep()}},{key:"_changeDepSelect",value:function(){this.checkoutNoAddrRadio.prop("checked",!0),$("#checkout-self [value='0']").prop("selected",!0),$("#checkout-self").sinhronize(),this._deblockNextStep()}},{key:"_autocompleteOpen",value:function(){this.checkoutNoAddrRadio.prop("checked",!0),$("#checkout-self [value='0']").prop("selected",!0),$("#checkout-self").sinhronize(),$("#checkout-dep [value='0']").prop("selected",!0),$("#checkout-dep").sinhronize(),this._deblockNextStep(),this.autocompleteList.css("display","block");var t=this.autocompleteInput.val().toUpperCase();this.autocompleteList.find(".active").removeClass("active"),""!=t&&(this.autocompleteList.find("li").css("display","block").removeClass("ac-hide"),this.autocompleteList.find("li").each(function(){var e=$(this).find("span").text().toUpperCase();0!=e.indexOf(t)&&$(this).css("display","none").addClass("ac-hide"),e==t&&$(this).addClass("active")}))}},{key:"_autocompleteClose",value:function(){var t=this;setTimeout(function(){t.autocompleteList.css("display","none"),t.autocompleteList.find(".active").removeClass("active")},200)}},{key:"_autocompleteKeyup",value:function(t){var e=this.autocompleteInput.val().toUpperCase();this.autocompleteList.find("li").css("display","block").removeClass("ac-hide"),this.autocompleteList.find("li").each(function(){var t=$(this).find("span").text().toUpperCase();0!=t.indexOf(e)&&$(this).css("display","none").addClass("ac-hide")});var a=void 0;if(t.originalEvent.keyCode?a=t.originalEvent.keyCode:t.originalEvent.which&&(a=t.originalEvent.which),40!=a&&38!=a&&13!=a&&this.autocompleteList.find(".active").removeClass("active"),40==a){var d=this.autocompleteList.find(".active");d.length?d.next().not(".ac-hide").is("li")&&(this.autocompleteList.find(".active").removeClass("active"),d.next().addClass("active")):this.autocompleteList.find("li").not(".ac-hide").eq(0).addClass("active")}if(38==a){var c=this.autocompleteList.find(".active");c.length&&c.prev().not(".ac-hide").is("li")&&(this.autocompleteList.find(".active").removeClass("active"),c.prev().addClass("active"))}if(13==a){var o=this.autocompleteList.find(".active");o.length&&(this._autocompleteChoose(o.find("span")),this.autocompleteInput.blur())}}},{key:"_autocompleteChoose",value:function(t){this.autocompleteInput.val($.trim($(t).text())),this.autocompleteId.val($.trim($(t).attr("data-id"))),$.ajax({url:this.autocomplete.attr("data-autocomplete-city"),method:"get",data:"cityId="+$(t).attr("data-id")+"&cityName="+$(t).text(),dataType:"json",success:function(t){"OK"==t.status.toUpperCase()&&($("#checkout-dep").empty().append(t.deps),$("#checkout-dep").sinhronize())},error:function(t){console.error(checkoutUI.errorMsgAddr,t)}})}},{key:"_changePaymentForm",value:function(t){this.paymentForm.attr("action",$(t).attr("data-action")),$('.payment input[type="submit"]').val($(t).attr("data-submit")),$("[data-payments-com]").text($(t).attr("data-com")),$("[data-cart-total]").text($(t).attr("data-total")),$("[data-cart-hideninp1]").val($(t).attr("data-hideninp1")),$("[data-cart-hideninp2]").val($(t).attr("data-hideninp2"))}},{key:"_checkAddrClick",value:function(t,e){$(e).prev().prop("checked")&&(this.checkoutNoAddrRadio.prop("checked",!0),this._deblockNextStep(),t.preventDefault())}},{key:"_eventHandlersInit",value:function(){var t=this;$(".checkout-box").length&&$(".custom-checkbox label").on("click",function(e){t._checkAddrClick(e,e.target)}),this.checkoutEditAddr.on("click",function(e){t._openEditAddrPopup(e.target)}),this.checkoutTabs.on("click",function(e){t._toggleTab(e.target)}),this.checkoutShopSelect.on("change",function(e){t._changeShop(e.target)}),this.checkoutAddrRadio.on("change",function(e){t._changeAddrRadio(e.target)}),this.depSelect.on("change",function(){t._changeDepSelect()}),this.checkoutAddrForm.on("submit",function(e){return t._checkoutAddrFormSubmit(t.statusAddress),t.addNewaddrPopup.closePopup(),!1}),this.autocompleteInput.on("focus",function(){t._autocompleteOpen()}),this.autocompleteInput.on("blur",function(){t._autocompleteClose()}),this.autocompleteList.find("span").on("mousedown",function(e){t._autocompleteChoose(e.currentTarget)}),this.autocompleteInput.on("keyup",function(e){t._autocompleteKeyup(e)}),this.paymentForm.on("change",function(e){t._changePaymentForm(e.target)}),this.checkoutAddNewAddr.on("click",function(e){t._openPopupForAddNewAddr(e.target)}),this.idFormAddNewAddress.on("submit",function(e){return t._checkoutAddNewAddrFormSubmit(),t._checkNumberOfAddresses(),t.addNewaddrPopup.closePopup(),!1}),$(".checkout-box-append").on("click",".checkout-address__edit",function(e){t._openEditAddrPopup(e.target)}),$(".checkout-box-append").on("change",'[type="radio"]',function(e){t._changeAddrRadio(e.target)})}}]),t}(),checkoutUI=new FrondevoCheckoutUI;